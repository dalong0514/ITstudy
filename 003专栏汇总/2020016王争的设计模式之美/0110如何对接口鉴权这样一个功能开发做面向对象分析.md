# 0110 | 实战二（上）：如何对接口鉴权这样一个功能开发做面向对象分析？

王争 2019-12-02




2.0x





讲述：冯永吉 大小：12.92M 时长：14:06

面向对象分析（OOA）、面向对象设计（OOD）、面向对象编程（OOP），是面向对象开发的三个主要环节。在前面的章节中，我对三者的讲解比较偏理论、偏概括性，目的是让你先有一个宏观的了解，知道什么是 OOA、OOD、OOP。不过，光知道「是什么」是不够的，我们更重要的还是要知道「如何做」，也就是，如何进行面向对象分析、设计与编程。

在过往的工作中，我发现，很多工程师，特别是初级工程师，本身没有太多的项目经验，或者参与的项目都是基于开发框架填写 CRUD 模板似的代码，导致分析、设计能力比较欠缺。当他们拿到一个比较笼统的开发需求的时候，往往不知道从何入手。

对于「如何做需求分析，如何做职责划分？需要定义哪些类？每个类应该具有哪些属性、方法？类与类之间该如何交互？如何组装类成一个可执行的程序？」等等诸多问题，都没有清晰的思路，更别提利用成熟的设计原则、思想或者设计模式，开发出具有高内聚低耦合、易扩展、易读等优秀特性的代码了。

所以，我打算用两节课的时间，结合一个真实的开发案例，从基础的需求分析、职责划分、类的定义、交互、组装运行讲起，将最基础的面向对象分析、设计、编程的套路给你讲清楚，为后面学习设计原则、设计模式打好基础。

话不多说，让我们正式开始今天的学习吧！

案例介绍和难点剖析

假设，你正在参与开发一个微服务。微服务通过 HTTP 协议暴露接口给其他系统调用，说直白点就是，其他系统通过 URL 来调用微服务的接口。有一天，你的 leader 找到你说，「为了保证接口调用的安全性，我们希望设计实现一个接口调用鉴权功能，只有经过认证之后的系统才能调用我们的接口，没有认证过的系统调用我们的接口会被拒绝。我希望由你来负责这个任务的开发，争取尽快上线。」

leader 丢下这些话就走了。这个时候，你该如何来做呢？有没有脑子里一团浆糊，一时间无从下手的感觉呢？为什么会有这种感觉呢？我个人觉得主要有下面两点原因。

1. 需求不明确

leader 给到的需求过于模糊、笼统，不够具体、细化，离落地到设计、编码还有一定的距离。而人的大脑不擅长思考这种过于抽象的问题。这也是真实的软件开发区别于应试教育的地方。应试教育中的考试题目，一般都是一个非常具体的问题，我们去解答就好了。而真实的软件开发中，需求几乎都不是很明确。

我们前面讲过，面向对象分析主要的分析对象是「需求」，因此，面向对象分析可以粗略地看成「需求分析」。实际上，不管是需求分析还是面向对象分析，我们首先要做的都是将笼统的需求细化到足够清晰、可执行。我们需要通过沟通、挖掘、分析、假设、梳理，搞清楚具体的需求有哪些，哪些是现在要做的，哪些是未来可能要做的，哪些是不用考虑做的。

2. 缺少锻炼

相比单纯的业务 CRUD 开发，鉴权这个开发任务，要更有难度。鉴权作为一个跟具体业务无关的功能，我们完全可以把它开发成一个独立的框架，集成到很多业务系统中。而作为被很多系统复用的通用框架，比起普通的业务代码，我们对框架的代码质量要求要更高。

开发这样通用的框架，对工程师的需求分析能力、设计能力、编码能力，甚至逻辑思维能力的要求，都是比较高的。如果你平时做的都是简单的 CRUD 业务开发，那这方面的锻炼肯定不会很多，所以，一旦遇到这种开发需求，很容易因为缺少锻炼，脑子放空，不知道从何入手，完全没有思路。

对案例进行需求分析

实际上，需求分析的工作很琐碎，也没有太多固定的章法可寻，所以，我不打算很牵强地罗列那些听着有用、实际没用的方法论，而是希望通过鉴权这个例子，来给你展示一下，面对需求分析的时候，我的完整的思考路径是什么样的。希望你能自己去体会，举一反三地类比应用到其他项目的需求分析中。

尽管针对框架、组件、类库等非业务系统的开发，我们一定要有组件化意识、框架意识、抽象意识，开发出来的东西要足够通用，不能局限于单一的某个业务需求，但这并不代表我们就可以脱离具体的应用场景，闷头拍脑袋做需求分析。多跟业务团队聊聊天，甚至自己去参与几个业务系统的开发，只有这样，我们才能真正知道业务系统的痛点，才能分析出最有价值的需求。不过，针对鉴权这一功能的开发，最大的需求方还是我们自己，所以，我们也可以先从满足我们自己系统的需求开始，然后再迭代优化。

现在，我们来看一下，针对鉴权这个功能的开发，我们该如何做需求分析？

实际上，这跟做算法题类似，先从最简单的方案想起，然后再优化。所以，我把整个的分析过程分为了循序渐进的四轮。每一轮都是对上一轮的迭代优化，最后形成一个可执行、可落地的需求列表。

1. 第一轮基础分析

对于如何做鉴权这样一个问题，最简单的解决方案就是，通过用户名加密码来做认证。我们给每个允许访问我们服务的调用方，派发一个应用名（或者叫应用 ID、AppID）和一个对应的密码（或者叫秘钥）。调用方每次进行接口请求的时候，都携带自己的 AppID 和密码。微服务在接收到接口调用请求之后，会解析出 AppID 和密码，跟存储在微服务端的 AppID 和密码进行比对。如果一致，说明认证成功，则允许接口调用请求；否则，就拒绝接口调用请求。

2. 第二轮分析优化

不过，这样的验证方式，每次都要明文传输密码。密码很容易被截获，是不安全的。那如果我们借助加密算法（比如 SHA），对密码进行加密之后，再传递到微服务端验证，是不是就可以了呢？实际上，这样也是不安全的，因为加密之后的密码及 AppID，照样可以被未认证系统（或者说黑客）截获，未认证系统可以携带这个加密之后的密码以及对应的 AppID，伪装成已认证系统来访问我们的接口。这就是典型的「重放攻击」。

提出问题，然后再解决问题，是一个非常好的迭代优化方法。对于刚刚这个问题，我们可以借助 OAuth 的验证思路来解决。调用方将请求接口的 URL 跟 AppID、密码拼接在一起，然后进行加密，生成一个 token。调用方在进行接口请求的的时候，将这个 token 及 AppID，随 URL 一块传递给微服务端。微服务端接收到这些数据之后，根据 AppID 从数据库中取出对应的密码，并通过同样的 token 生成算法，生成另外一个 token。用这个新生成的 token 跟调用方传递过来的 token 对比。如果一致，则允许接口调用请求；否则，就拒绝接口调用请求。

这个方案稍微有点复杂，我画了一张示例图，来帮你理解整个流程。

3. 第三轮分析优化

不过，这样的设计仍然存在重放攻击的风险，还是不够安全。每个 URL 拼接上 AppID、密码生成的 token 都是固定的。未认证系统截获 URL、token 和 AppID 之后，还是可以通过重放攻击的方式，伪装成认证系统，调用这个 URL 对应的接口。

为了解决这个问题，我们可以进一步优化 token 生成算法，引入一个随机变量，让每次接口请求生成的 token 都不一样。我们可以选择时间戳作为随机变量。原来的 token 是对 URL、AppID、密码三者进行加密生成的，现在我们将 URL、AppID、密码、时间戳四者进行加密来生成 token。调用方在进行接口请求的时候，将 token、AppID、时间戳，随 URL 一并传递给微服务端。

微服务端在收到这些数据之后，会验证当前时间戳跟传递过来的时间戳，是否在一定的时间窗口内（比如一分钟）。如果超过一分钟，则判定 token 过期，拒绝接口请求。如果没有超过一分钟，则说明 token 没有过期，就再通过同样的 token 生成算法，在服务端生成新的 token，与调用方传递过来的 token 比对，看是否一致。如果一致，则允许接口调用请求；否则，就拒绝接口调用请求。

优化之后的认证流程如下图所示。

4. 第四轮分析优化

不过，你可能会说，这样还是不够安全啊。未认证系统还是可以在这一分钟的 token 失效窗口内，通过截获请求、重放请求，来调用我们的接口啊！

你说得没错。不过，攻与防之间，本来就没有绝对的安全。我们能做的就是，尽量提高攻击的成本。这个方案虽然还有漏洞，但是实现起来足够简单，而且不会过度影响接口本身的性能（比如响应时间）。所以，权衡安全性、开发成本、对系统性能的影响，这个方案算是比较折中、比较合理的了。

实际上，还有一个细节我们没有考虑到，那就是，如何在微服务端存储每个授权调用方的 AppID 和密码。当然，这个问题并不难。最容易想到的方案就是存储到数据库里，比如 MySQL。不过，开发像鉴权这样的非业务功能，最好不要与具体的第三方系统有过度的耦合。

针对 AppID 和密码的存储，我们最好能灵活地支持各种不同的存储方式，比如 ZooKeeper、本地配置文件、自研配置中心、MySQL、Redis 等。我们不一定针对每种存储方式都去做代码实现，但起码要留有扩展点，保证系统有足够的灵活性和扩展性，能够在我们切换存储方式的时候，尽可能地减少代码的改动。

5. 最终确定需求

到此，需求已经足够细化和具体了。现在，我们按照鉴权的流程，对需求再重新描述一下。如果你熟悉 UML，也可以用时序图、流程图来描述。不过，用什么描述不是重点，描述清楚才是最重要的。考虑到在接下来的面向对象设计环节中，我会基于文字版本的需求描述，来进行类、属性、方法、交互等的设计，所以，这里我给出的最终需求描述是文字版本的。

调用方进行接口请求的时候，将 URL、AppID、密码、时间戳拼接在一起，通过加密算法生成 token，并且将 token、AppID、时间戳拼接在 URL 中，一并发送到微服务端。

微服务端在接收到调用方的接口请求之后，从请求中拆解出 token、AppID、时间戳。

微服务端首先检查传递过来的时间戳跟当前时间，是否在 token 失效时间窗口内。如果已经超过失效时间，那就算接口调用鉴权失败，拒绝接口调用请求。

如果 token 验证没有过期失效，微服务端再从自己的存储中，取出 AppID 对应的密码，通过同样的 token 生成算法，生成另外一个 token，与调用方传递过来的 token 进行匹配；如果一致，则鉴权成功，允许接口调用，否则就拒绝接口调用。

这就是我们需求分析的整个思考过程，从最粗糙、最模糊的需求开始，通过「提出问题 - 解决问题」的方式，循序渐进地进行优化，最后得到一个足够清晰、可落地的需求描述。

重点回顾

今天的内容到此就讲完了。我们一块来总结回顾一下，你需要掌握的一些重点内容。

针对框架、类库、组件等非业务系统的开发，其中一个比较大的难点就是，需求一般都比较抽象、模糊，需要你自己去挖掘，做合理取舍、权衡、假设，把抽象的问题具象化，最终产生清晰的、可落地的需求定义。需求定义是否清晰、合理，直接影响了后续的设计、编码实现是否顺畅。所以，作为程序员，你一定不要只关心设计与实现，前期的需求分析同等重要。

需求分析的过程实际上是一个不断迭代优化的过程。我们不要试图一下就能给出一个完美的解决方案，而是先给出一个粗糙的、基础的方案，有一个迭代的基础，然后再慢慢优化，这样一个思考过程能让我们摆脱无从下手的窘境。

课堂讨论

除了工作中我们会遇到需求不明确的开发任务，实际上，在面试中，我们也经常遇到一些开放性的设计问题，对于这类问题，你是如何解答的？有哪些好的经验可以分享给大家呢？

欢迎在留言区写下你的答案，和同学一起交流和分享。如果有收获，也欢迎你把这篇文章分享给你的朋友。

将学到的知识总结成笔记，方便日后快速查找及复习

unpreview


© 版权归极客邦科技所有，未经许可不得传播售卖。页面已增加防盗追踪，如有侵权极客邦将依法追究其法律责任。

大龙

由作者筛选后的优质留言将会公开显示，欢迎踊跃留言。

Command + Enter 发表

0/2000 字

提交留言

精选留言 (113)

编程界的小学生

工作中遇到非 crud 的需求我就会想尽一切办法让他通用，基本需求分析和需求设计的时间占用百分之五十，开发和重构到自认为最优占用百分之五十。比如最简单的验证码功能，几乎每个项目都有，我就封装一套验证码服务，主要功能有你在配置文件里配置好需要被验证码拦截的路径，这里还要考虑到通配符，空格等等细节和可扩展的点，内置图片验证码，极验证，手机验证以及自定义验证码等等，总之我认为如果有机会遇到非 crud 的需求，一定要好好珍惜，好好把握，把他打造成属于自己的产品，这样会让自己下意识的去想尽一切办法把他做到最优，亲儿子一样的待遇，再也不会无脑 cv，连变量名可能都要认真的重构一两遍😹😹😹

2019-12-02


辣么大

一句话：使用进化算法的思想，提出一个 MVP（最小可行性产品），逐步迭代改进。

拿到这个需求，假设我们不了解接口鉴权，需求又不明确，我会我自己如下问题：

1. 什么叫接口鉴权？搞清基本概念

2. 接口鉴权最佳实践是什么？技术调研

3.appid 和 secret key 从哪里来？用户自己申请还是我们授权？用户申请是以什么方式申请（网页还是邮件？申请的网页有人做了么？）追问下去。

4.appid secretkey 存储在什么地方呢？数据存储

5. 用户如何使用？需要为用户提供接口鉴权使用手册和文档，及示例代码。写用户手册，文档。

6. 这个功能如何测试？提前想好如何测试

7. 接口鉴权功能何时上线？估计工期

8. 鉴权成功或失败返回码和信息定义？约定返回结果

关于防止重放攻击：请求参数中还可以加入 nonce（随机正整数），两次请求的 nonce 不能重复，timestamp 和 nonce 结合进一步防止重放攻击。

2019-12-02


aoe


OAuth 2.0 + 网关（如 Zuul）+ 认证中心 + AOP 可以实现。

极客时间《微服务架构实战 160 讲》里介绍了 OAuth 2.0 企业级的解决方案，小争哥的方案适合快速落地。

实际业务中如果安全等级没这么高，直接生成 Token 鉴权就可以。通过业务模型规避风险：

1. 充值类业务，就算对方篡改接口，最终结果可以通调用证金融机构的接口验证是否有效，不会给公司带来损失。

2. 如果安全等级非常高，比如提现、转账可以通过发送手机短信，确保是本人操作。

3. 如果是商品信息查询类接口，防止第三方爬取数据，可以在调用一定次数后加入」人机验证「（输入图片识别码、拼图）。

4. 根据 IP 限制访问次数。

5. 服务器间调用可以绑定 mac 地址、IP。

6. 服务器、客户端通过架设私有 VPN 进行通信，将安全问题转移到 VPN 上，降低业务复杂度的同时还可以避免加解密带来的性能损耗，提升性能。

7. 调用接口时通过付费方式（如实名认证、银行四要素验证这些调用一次都是要收费的），防止恶意调用。

8. 通过独立加密硬件（如 U 盾）+ 独立密码验证器（Google 验证器）+ 语音识别 + 面部识别（刷脸支付） + 指纹 + 多人同时输入动态秘钥（核打击时发射程序）。

9. 安全性会降低系统性能适可而止。

极客时间《左耳听风》专栏中介绍了亚马逊在设计开发微服务时，就已经做好了随时对外网开放的准备，由于没有阅读完整个专栏，不知道后面有没有详细介绍。

2019-12-03


qinsi


光拼 url 是不够的，只能覆盖如 HTTP GET 一类参数在 url 中的请求，对于如 POST 和 PUT 一类的请求，因为参数通常在 body 中，就没有参与 token 的生成。又因为这样的方案存在允许重放请求的时间间隔，就可能导致的情况是中间人截获了请求，在允许重放的时间间隔内任意修改 body 中的参数后发送，让接口鉴权形同虚设

作者回复：嗯嗯，说的有道理～

2019-12-08


阿卡牛

还有个风险，如果调用方是 app，那有可能 app 被反编译，然后加密算法就被第三方知道了

2019-12-02


安静的 boy

这个需求去年我就做过，给自己系统的对外接口开发一个鉴权的功能。因为之前了解过 oauth2，当时就直接想到了 oauth2 鉴权来实现，就去学习了下，然后选择了「客户端模式」来实现，给各个应用分配 appid 和 appsecrete，客户端拿 appid 和 appsecrete 请求有一定时效的 token，应用拿到 token 后再跟 appid 和 appsecrete 一起来请求接口，服务端鉴权通过后即可调用。老师的例子是客户端定开始时间，我做的是服务端定开始时间。

不过当时分析的时候没有意识去一步步分析，就是一下子想起来就去做了，也没有去想着做什么优化，以后在遇到这种问题，应该多去分析，思考，才能让设计更优。

2019-12-02


黄林晴

打卡

充血模型那两节还没完全理解，加油

2019-12-02


Murrre


https://github.com/murreIsCoding/auth


根据实战教程编写的，放到了 github 上

2019-12-06


追风少年

老师好，感觉在鉴权这个例子中，无论客户端如何加密，攻击方的逻辑都是不变的。只需要截获请求，并不需要解析 token.

如果能在 token 中加入客户端的特征变量，比如 ip 或者 mac，服务端获取特征变量，然后和 appid 等一起生成 token 再比较。这样会更好。要不然总感觉在自欺欺人

2019-12-05


Young！


像今天的例子中，如果老板给我这样的需求，我第一反应就是去想怎么实现，用什么技术实现，有什么现成的框架，而不是去先思考「用户名密码登录验证」这最基础的第一步。刚开始脑子就一团浆糊，知道完成也是在便实现便理思路，这样浪费时间而且最后也没有自己完整的思路过程。

以后还是要先理清思路，理清需求再去考虑每一小需求实现的技术。

2019-12-02


刘大明

一般遇到这种需求不是特别明确的，先自己理解第一遍需求，有一个大概的思路，然后在和产品经理确认是不是这样。需求确认之前在按照争哥说的需求分析，对需求做任务分解，将需求分解成一个个小的任务点，每个小任务都是很容易执行的。就算开发过程中被打断了，也不要紧。任务分解的尽量小，这样重新回到开发状态也就越容易。

2019-12-02


小白

防止重放攻击的方案在老师的基础做进一步的迭代设计:

1. 要求客户端生成一个唯一的请求 id，如以 uuid 方式

2. 客户端在以 sha 等加密哈希方式生成 token 时，也将请求 id 加入其中

3. 客户端也要将请求 id 作为参数传递到服务端，如果是 rest api 就是也要将请求 id 拼接到 url 参数中

4. 服务端检查服务端的缓存中 (可以是 redis) 是否有客户端传递的请求 id，如果有，则判定为重放攻击，拒绝请求。如果没有，则将请求 id 放到缓存中同时设置在 token 失效的时间窗内缓存的请求 id 自动失效 (如 redis key 的 TTL)

这个实现思路是：在时间窗内的重放攻击，以服务端在时间缓存了在时间窗内的所有请求 id 的形式来防护，而在时间窗外的重放攻击就是老师的方案中检查客户端传过来的时间 (时间戳) 和服务端当前时间 (时间戳) 相减的绝对值不能超过时间窗的长度来实现。另外，时间戳、请求 id 等都 hash 在了 token

中，所有客户端是无法篡改的。

这个实现思路的缺点是：改实现方案要求客户端的时间和服务端的时间之间的差距不能超过时间窗，如果时间窗设置为 1 分钟这种比较小的，则要求客户端时间和服务端时间不能超过 1 分钟，这个有点苛刻，比如客户端如 app 所在的手机的时间不准确了，但就差 1 分钟，将无法访问接口。如果时间窗设置过长，如 30 分钟，则要求服务端缓存中缓存最近 30 分钟的请求 id，如果接口的访问并发挺大的话，缓存占用空间也将很大，需要评估。

2019-12-05


Richard Zhong


我看到过的最好的设计模式课

2019-12-02


趙衍

我觉的老师的方案也没有增加攻击方的试错成本吧，我每次截获调用接口的请求，获取你调用的 URL，在这个过期时间内仍然可以非法调用微服务方的接口啊。做了这么多的加密，可是对于攻击方，我的攻击成本增加在哪里了呢？

请老师解答一下哈

2019-12-04


板栗饼

课依然很好，就是有些想念算法之美里每节画插图的小姐姐

2019-12-04


QQ 怪

老师，我们公司有个重构项目，也是要最客户端鉴权，但是旧客户端没有做 token 之类的鉴权传 token，但现在要做，如何做到兼容旧客户端做鉴权呢？

作者回复：后端可以对没有传递 token 的不做校验

2019-12-02


陈迎春

我主要是嵌入式软件开发的，这个鉴权功能基本理解了，但是前面的 mvc，包括贫血和充血，还是挺不明白的，平时没有用过，理解有些困难，暂时先放放吧，等后面再回过来学习

2019-12-02


不似旧日

有个问题：通过同样的 token 生成算法，在服务端生成新的 token，与调用方传递过来的 token 比对。这个做法是不是有点多余？ 能把 token 解密难道不能说明 token 没有问题么？

作者回复: token 是单向加密算法生成的 无法解密的

2019-12-02


梦倚栏杆

我是做业务需求的：我们期望于产品画清楚流程图，表达好规则描述，

a. 有些产品做的足够细致时，rd 照着流程实现就好了。

b. 有些产品表达的很粗糙，rd 会按照自己的梳理，然后向产品要相关时刻的规则，最后 rd 再照着实现。

感觉针对一个具体业务需求时，貌似技术实现到底多么优雅取决于与之合作的产品，总觉得不对，但貌似又无能为力

2019-12-02


丁丁历险记

1 推荐写 markdown 进行描述

2 分析将做什么转为怎么做，并将怎么做拆解的足够小，单步可验。

3 过程是渐进的，逐步分解

2019-12-06


马超

这个鉴权功能需求分析的很好，但是和面向对象分析没有多大关系吧。

作者回复：我理解的面向对象分析，就是需求分析。

2019-12-04


teddytyy


老师，时间戳要不要拼接在 url 里产生 token 应该都可以吧？服务端反正是按照 url 里解析的时间戳去过滤的

作者回复：放到里面的目的是让每次生成的 token 都不一样

2019-12-02


Lyre


client 端生成的 token 在时间窗口内，假如用户在操作中停留了 1 分钟（时间窗口），那 token 就过期了吗？

作者回复：是要发送请求到服务器的时候才生成 token

2019-12-02


2018


打卡，依旧在理解贫血和充血模型

2019-12-02


QFY


如果遇到这种需求，我一般是直接去找比较成熟的解决方案，参照着写，自己思考的地方就少了很多，不是一个很好的习惯

2020-03-30


eason2017


这个需求上还有一个小问题，就是这个时间戳有效期是一分钟，感觉，不同手机的时间和系统的时间是存在差异的，可能还没到过期时服务端校验时间有效性时，已经认为过期了。

2020-01-10


修缘

遵循合适原则、简单原则、演化原则三个原则，有助于做出最好的选择。在实际的项目中，我们要结合业务 、技术、成本三个方面综合考虑具体的方案。

2019-12-05


阿冰 777

Day10: 先设计，在完成核心功能试验，设计时要考虑以后可能的改动，要考虑最常用场景的性能优化，如果这个功能和已有功能有重叠，考虑进行重构，如果没有重叠但是有使用相同的数据，要考虑到是否有数据不一致的 bug, 设计时还要考虑到极端情况，最好先写出测试 case。

2019-12-04


wenxueliu


不是应该先有调研过程吗？直接就开始设计的？

作者回复：那估计还有会议讨论 立项之类的流程吧

2019-12-04


PHP 是世界上最好的需要

在不懂接口鉴权的需求下，很难总结出」粗糙「的功能框架，这个时候如何解决呢？

作者回复：为什么不懂呢？理论上讲这个需求比较简单的 不懂可以去找需求提出方了解

2019-12-02


杰洛特

请问老师，token 在 client 端生成的话，是否意味着要告知 client 端加密算法？然后才能在 server 端解密到信息

作者回复：是的 要统一加密算法

2019-12-02


我又不乱来

老师现在我有一个疑问，基于充血模式，我有一个 domain 要查询数据库，如何做比较合适呢？

作者回复：下一节课有答案 你可以看下

2019-12-02


sabo


前一段写了一套 open api，使用鉴权方式就是老师描述的这种基于 AK/SK 的签名验证。这种方式感觉有一个问题就是如果是一个具有很大请求内容的 post 方法，签名的成本感觉还是挺高的。还有一种方式是服务端给客户端下发一个有一定时长的 token，然后客户端的每次请求都带着这个 token。

2019-12-02


L🚲🐱


前面讲的充血模型还有点不理解，准备这几天写个 demo 实践一下，加深理解

2019-12-02


润！

作者这样的授课方式解答了我脑海里很多的疑问，赞一个

2020-07-14


御风

token 加密算法是单向的，那么被截获后，黑客只能用同一请求不断重复攻击吧，重复请求过多导致服务端垮掉吧。

2020-07-04


微末凡尘

让我想到了微信登陆接口中的 code，一次有效。5 分钟之内有效，最近在研究公司的 sdk，服务端先生成 token，下发给客户端，游戏服务端拿到 token，发送到服务端，验证 token，走完整个环路，才算登录成功

2020-07-02


郭俊杰

我在接入第三方服务时，观察过。果然调用的方式跟老师讲的一模一样到第三步，终于明白人家为啥要这么设计了。

2020-06-04


朝小树

如果用户本地时间不对的话，应该每次请求都会失效；

2020-05-24


李达龙

拿到需求一般回问清楚，越具体越好，但是完成功能开发，在测试阶段

2020-05-23


李德政

还可以在优化一下方案：参数里面增加随机数，服务端记录随机数，这样可以保证一个请求最多只被执行一次。

2020-05-21


师哥

面向对象分析是一个循序渐进的过程。

2020-05-14


track6688


完全被说中了，确实很多时候，拿到一个需求，我都会一片空。我也拿我手上的一个小需求跟着老师的思路，分析了一遍，感觉是比较清楚了。喜欢这些经验文章。

2020-05-07


JKwar


碰到过图片加载功能的需求，尽可能抽象，预留扩展点。

2020-05-06


Geek_小白

一直在用啊 公总号 token

2020-04-27


Geek_519725


建议对加密这块有疑惑的的同学可以了解下：对称加密、非对称加密、摘要算法。本文中用到的是 SHA 算法，实际上就是 hash，其实这不叫加密算法，因为无法解密，这个应该叫做摘要算法，它是不可逆的，即使知道算法，也无法知道原始数据是啥。所以只要确保密码不被泄露，那么这个链接被截获也无所谓。

2020-04-26


酸辣土豆丝

首先会跟问清楚需求具体的内容，有哪些注意点，然后调研下，是否有现有的框架，案例，分析清楚，根据自己的场景进行改动

2020-04-13


KK


没有第四轮分析优化了吗？第四轮只是说了一下其加入时间戳之后的合理性。哈哈哈

2020-04-04


张三

这个感觉就是一个用户名密码登录的安全性方面考虑的例子。

2020-04-04


这得从我捡到一个鼠标垫开始说起

使用 https 不就是密文传输了，既然是密文传输，那就不会泄露 appid 和 secret。这鉴权不就是验证调用方的身份吗，跟登录微信 qq 是一个东西，输入账号密码，验证成功就算登录了。

2020-03-31


秋风画扇

1. 罗列功能需求 2. 提取相关属性行为 3. 聚合分装成对象 4. 编码实现 5. 重构调整 就是不断抽取优化，像我一样进行分析编码的有没有？

2020-03-22


肖臧

其实这种鉴权系统在 SaaS 系统里很多，Facebook Messenger Platform，各大短信网关。这次 OOA 只分析了鉴权过程，那么 password 或者 secret 的生成、修改和展示并没有写出，我觉得不够完整。

2020-03-15


大王叫我来巡山

正常情况下都是先找现成的，然后比对业务需求分析契合度，稍加改动直接上线

2020-03-10


千锤百炼领悟之极限

client 的系统时间与服务器时间不一致就会导致验证失败，应该在服务器加一个接口获取服务器当前时间，client 用获取的这个时间作为 ts 传输。

2020-03-02


binarylei


今天看到百度翻译 api 的设计，和老师讲得差不多 <https://api.fanyi.baidu.com/doc/21>

2020-02-27


未来小娃

【设计模式笔记 14】20200227

本次以接口鉴权展示乐面向对象编程的一般流程：也就是进行面向对象得需求分析，将模糊的需求细化为可落地的具体的需求，可以按照最小可行性产品思维思考，到底是什么才是该需求要解决问题，需要哪些功能，分别用来做什么的，如果有专业术语也要搞清楚与需求本身的联系，逐步讲抽象的描述具体化流程化。要提醒自己，你理解的需求和 PD 写的需求可能不是同一个东西，一定要多沟通确认清楚，随着业务复杂度的增加，我们需要深入理解业务，业务都理解不清楚妄谈领域驱动设计是毫无意义的，画图是一个很好理解业务的方法，大部分时候我们可能只负责某一个模块，但是如果跳出来主动去看整个业务链路你理解的深度也会加深

2020-02-27


somenzz


这就是我最新使用的 JWT

2020-02-23


Heaven


我记得我之前面试一家公司的时候，面试官曾经出过一个问题，如何保证在一台电脑上不同的浏览器，只要有一个浏览器登陆的账号，其他浏览器在登录的时候也可以做到直接登陆呢

针对这种比较笼统的需求的时候，我一开始给出的想法是请求服务端的时候利用请求者的 IP 地址，如果他的 IP 地址在我们的数据库中存储了，那么就直接进行登录，如果发现了异地存储，再利用手机号验证这种方式，将数据库里面的登录 IP 改为新的 IP，但是这样的话，无法防止攻击者伪装他人的 IP 地址进行登录，于是乎我联想一下我能不能在本机上，保存一个文件，然后每次无论什么浏览器去访问的时候都去读取这个文件，并且带的文件上面的信息去直接请求，直白说就是账号密码，后来我想到了 host 文件，因为一般来说 host 的文件都是将网站名和网站的真实 IP 进行相映射的，那么我们可以在用户登录的时候去读取 host 文件，当然再过于具体的实现我没有给出，这只是我的一个思路，后来面试官说这也算是一种实现思路，不过就是比较流氓。也不知道大家有什么更好的实现思路

2020-02-20


张理查 rootv

能否记录最后一次访问的 ts，即同 ts 只能访问一次，这样做除了会损失一定的性能，还有什么缺点呢？

2020-02-10


涉蓝

有个问题是 如果都是内网调用的话 还需要这样的鉴权吗？ 我们公司的好多服务只有内网的 然后有的服务搞了类似加密验签的东西 有的完全没有

如果内网的话 似乎意义不大 要是黑客都摸到内网了 也就防不住啥的感觉

2020-02-09


静静聆听

老师是在介绍面向对象设计的思路，评论都是抓着 token 问题不放，这是重点么？老师我就想问下，您的这四步其实应该都属于面向对象设计把

2020-01-30


不似旧日

第二轮优化图文不符，文中说的是通过 appId 查出接口信息依同样的加密算法得到 token_s, 拿 token_s 与请求的 token 对比

图片上的是解析 token 对比参数是否一致

2020-01-13


Ben


迭代第二轮生成 token 时，请求接口的 URL 是固定的，加或不加好像没什么区别

2020-01-03


fly


服务之间的调用，通过验权，最早是用两边约定的密码 + appId。后来参考微信和支付宝改成文中最后的样子：appId、url 参数、时间 + 密码的组合。我想说的是，没思路的时候看看开放平台的接口，也能提供很多帮助

2019-12-30


至今未来

看评论看的我怀疑人生？ https post 请求数据放在 body 里 不是很稳的么。

2019-12-27


alls well


针对嵌入式设备来讲，需求就是应付，产品经理给出 OR 用于描述使用场景，软件分解出 DR-DS，解释 what 和 how 的问题。具体规格参数，软件要做和确认的太多。每次做这种感觉 or 就是形同虚设。如何做好嵌入式的需求呢？

2019-12-25


小妖

一般来讲，微服务间的接口调用默认应该是安全的，通过配置注册中心控制安全，不需要进行健全，非法用户根本不可能允许注册。文章中讲的这些更适合的场景是和第三方服务进行接口对接，是完全的 http restf 请求

2019-12-18


。。。。


没太理解 client 端是哪个端？是 app 还是服务端的一个 client 提供方？我理解的是这样的一个请求先去请求先到服务端提供的 clent 服务获取到一个新的路径，然后再去另一个服务端请求数据，是这样吗

2019-12-17


空知

重放功能加时间戳 + nonce 可以解决啊

2019-12-11


麟

例子一直在考虑微服务端，但是对于调用者怎么保证安全性？ 我能想到的就是每一次调用微服务接口，都需要去后台请求一下 token，但是总觉的这样很啰嗦，不知道有没有其他的办法？？

2019-12-11


        


可以通过非对称加密来解决

2019-12-10


cv0cv0


如果是用户自己，他就可以通过反编译 App 给自己账户加余额了。

2019-12-10


ning 先森

边学边思考...

2019-12-09


Murrre


https://github.com/murreIsCoding/auth


根据老师教程编写的实战

2019-12-06


progyoung


这就是需求分析的迭代嘛，看来是跟面向对象关系不大

2019-12-06


王一之

我看有些案例还会带上一个随机字符串的参数

2019-12-06


carol


从模糊的需求中得到功能点，根据功能点提供解决方案，不断提问发现解决方案中问题进行迭代，最终确定一个合理的解决方案，对最终的解决方法在进行描述，得到一个合理的、可落地的需求描述。

2019-12-06


shniu


针对需求不明确，表述含糊，理解上存在二义性的情况，只能把这些都搞清楚，这就体现出了一个良好的工作习惯和解决问题的方法的重要性。我的一般做法是：首先，试图理解需求，把有疑问的地方列出来，将这些问题分为功能性需求的问题和非功能性需求的问题，针对这两类问题分别解决，功能性需求问题，属于业务范畴，可能是自己的业务领域知识不足，也可能是功能需求描述不够细或者考虑不周全，去找相关人沟通，并不断积累业务知识和业务经验；对与非功能性需求，这个一般属于系统固有复杂度，需要自己多思考，查阅资料，借鉴他人的经验，找 leader 和同事沟通方案，不断优化调整，总之主动成长是必要的。

1. 需求理解，对领域知识进行强化，方式是沟通、搜索资料等

2. 根据实际业务估算业务对系统的非功能性的要求

3. 弄清楚需要用到的技术

4. 做技术 Spike

5. 设计技术实现方案

6. 设计测试方案，可能会调整对应的设计

7. 遇到问题解决问题

2019-12-04


sulatwx


课后思考：出现需求不明确的开发任务，大多是客户自己也不清楚要实现什么，或者说不清楚系统能实现到什么程度。这种情况下，不妨假设自己就是客户，充分了解客户的业务，或者参考以前类似的项目经验提出解决方案。

2019-12-04


Y024


Day029 13


针对不明确需求，通过「提出问题，解决问题」的方法，不断迭代逼近现实。其实 Kent Beck 推荐的 TDD 编码方式和这个方法也是类似：编写测试代码就好像是向系统提问题，编写系统代码是为了回答问题，这样的对话不断反复，最后生成的就是我们所需要的系统。

2019-12-03


圆圆

我有一些疑问，即然是防止黑客攻击，那么着重点不应该放在加密算法上吗？

我们即使用了 sha 算法，但是明文还是明明白白的放着。黑客把几个变量试几次之后就知道我们是什么大概情况进行的加密。他自己就可以造参数进行模拟。

我觉得对黑客来说，即使最后一种也和第一种一样简单。

希望大佬帮忙解答下疑问，感谢～

作者回复: sha 是单向加密算法 不知道是不是你误解了

2019-12-03


相逢是缘

打卡

1、需求分析是一个不断优化的过程，可以先给一个简单的方案，然后不断的优化，最后形成一个可执行、可落地的需求列表；

2、对于不熟悉的领域（方向），这里面要先搞清楚需求中的一些概念，进行技术调研，先做一个最基础的需求分析，可以很简单，再进行一步一步细节优化（优化的过程也是理解需求，确认需求的过程）；

3、形成文档（流程图、说明等）并存档进行文档的版本管理，这样后续在进行工作交接的时候，新来人员可以顺着文档修改记录，理清思路，快速熟悉业务。

2019-12-03


Paul Shan


需求是不断被追问下的产物，一开始的方案是迭代的起点，不要求尽善尽美，如果能充分理解业务问题，目的就已经达到。把这个方案放到各种场景下，不断扩充和调整，然后从安全性，效率，易用性，交付时间等维度再去权衡取舍，得出一个解决方案，整个过程确实费心费力，最后往往不是一个完美方案，而是权衡取舍各种条件下的折中，这可能就是工程的本质。

2019-12-03


Dimple


拿到这个需求，第一反应，自己有一个小的应用就是需要这种鉴权，想过好几种方案，最终自己选择的是 jwt 的方式，不过基本功能都在后端，前端并没有像老师这样考虑周全，也不知道当初自己是怎么想的。不过这下好了，需求对口，跟着课程学习，就可以找到属于适合我自己的方式来解决困惑。

2019-12-03


jon


老师能不能给个实例代码

作者回复：下一节课有的

2019-12-03


任鹏斌

这个方案简单实用，对安全性要求不是特别高的系统很实用。

2019-12-03


Jianzeng


今天这篇文章讲的就是工作所做的，marketing api，授权方案完全一样。

2019-12-03


Woosang


UML 之类只是一种表达方式，关键还是得理清思路，逐步迭代，也符合 PMP 的渐进明细的方式

2019-12-02


Woosang


UML 之类只是一种表达方式，关键还是得理清思路，逐步迭代，也符合 PMP 中渐进明细的思路

2019-12-02


南山

工作中的 CRUD 也是可以做的很精彩，业务有一定复杂度情况下，做共性抽象，识别稳定、易变的功能，对易变的功能通过一定程度的抽象，支持可扩展以及代码复用。对稳定的功能或者流程进行抽象，提高可读性、可维护性等等，这些都是可以做的比较出彩的地方，最好是基于充血模型，上来就 MVC 怼，早晚会玩不下去，对自己也不会有什么成长。

稍微复杂的业务场景，可以尝试充血模型来搞，至少是来思考～～～

2019-12-02


平风造雨

之前做相关非明确业务性需求，比较喜欢参考调研一些开源的代码，比如之前工作里做鉴权，参考了 spring security 相关 jwt 的实现

2019-12-02

