## 20231209åœ¨RAGæµç¨‹ä¸­æé«˜æ£€ç´¢æ•ˆæœ

[Improving Retrieval Performance in RAG Pipelines with Hybrid Search | by Leonie Monigatti | Nov, 2023 | Towards Data Science](https://towardsdatascience.com/improving-retrieval-performance-in-rag-pipelines-with-hybrid-search-c75203c2f2f5)

[åœ¨ RAG æµç¨‹ä¸­æé«˜æ£€ç´¢æ•ˆæœï¼šèåˆä¼ ç»Ÿå…³é”®è¯ä¸ç°ä»£å‘é‡æœç´¢çš„æ··åˆå¼æœç´¢æŠ€æœ¯ [è¯‘] | å®ç‰çš„åˆ†äº«](https://baoyu.io/translations/rag/improving-retrieval-performance-in-rag-pipelines-with-hybrid-search)

Improving Retrieval Performance in RAG Pipelines with Hybrid Search

How to find more relevant search results by combining traditional keyword-based search with modern vector search

2023-11-28

Leonie Monigatti

With the recent interest in Retrieval-Augmented Generation (RAG) pipelines, developers have started discussing challenges in building RAG pipelines with production-ready performance. Just like in many aspects of life, the Pareto Principle also comes into play with RAG pipelines, where achieving the initial 80% is relatively straightforward, but attaining the remaining 20% for production readiness proves challenging.

One commonly repeated theme is to improve the retrieval component of a RAG pipeline with hybrid search.

Developers who have already gained experience building RAG pipelines have started sharing their insights. One commonly repeated theme is to improve the retrieval component of a RAG pipeline with hybrid search.

This article introduces you to the concept of hybrid search, how it can help you improve your RAG pipeline performance by retrieving more relevant results, and when to use it.

[Retrieval-Augmented Generation (RAG): From Theory to LangChain Implementation | by Leonie Monigatti | Nov, 2023 | Towards Data Science](https://towardsdatascience.com/retrieval-augmented-generation-rag-from-theory-to-langchain-implementation-4e9bd5f6a4f2)

[The Untold Side of RAG: Addressing Its Challenges in Domain-Specific Searches | by Agustinus Nalwan | Oct, 2023 | Towards Data Science](https://towardsdatascience.com/the-untold-side-of-rag-addressing-its-challenges-in-domain-specific-searches-808956e3ecc8)

åœ¨ RAG æµç¨‹ä¸­æé«˜æ£€ç´¢æ•ˆæœï¼šèåˆä¼ ç»Ÿå…³é”®è¯ä¸ç°ä»£å‘é‡æœç´¢çš„æ··åˆå¼æœç´¢æŠ€æœ¯ [è¯‘]

æ¢è®¨å¦‚ä½•ç»“åˆä¼ ç»Ÿå…³é”®è¯æœç´¢ä¸ç°ä»£å‘é‡æœç´¢æ¥è·å¾—æ›´ç›¸å…³çš„æœç´¢ç»“æœ

æœ€è¿‘ï¼Œéšç€å¼€å‘è€…ä»¬å¯¹æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰æŠ€æœ¯çš„å…´è¶£æ¿€å¢ï¼Œå¦‚ä½•æ„å»ºèƒ½è¾¾åˆ°ç”Ÿäº§çº§æ€§èƒ½çš„ RAG æµç¨‹æˆäº†æ–°çš„æŒ‘æˆ˜ã€‚æ­£å¦‚ç”Ÿæ´»ä¸­çš„å…¶ä»–é¢†åŸŸï¼Œå¸•ç´¯æ‰˜åŸåˆ™ï¼ˆå³ 80/20 æ³•åˆ™ï¼‰åœ¨ RAG æµç¨‹ä¸­åŒæ ·é€‚ç”¨ï¼šåˆå§‹çš„ 80% ç›¸å¯¹å®¹æ˜“å®ç°ï¼Œè€Œè¦è®©å‰©ä½™çš„ 20% æ»¡è¶³ç”Ÿäº§æ ‡å‡†å°±æ¯”è¾ƒå›°éš¾äº†ã€‚

æå‡ RAG æµç¨‹æ£€ç´¢éƒ¨åˆ†æ€§èƒ½çš„ä¸€ä¸ªå¸¸è§è§£å†³æ–¹æ¡ˆæ˜¯é‡‡ç”¨æ··åˆæœç´¢ã€‚

é‚£äº›åœ¨æ„å»º RAG æµç¨‹æ–¹é¢æœ‰ç»éªŒçš„å¼€å‘è€…ä»¬å·²ç»å¼€å§‹åˆ†äº«ä»–ä»¬çš„å¿ƒå¾—ã€‚å…¶ä¸­ä¸€ä¸ªåå¤å‡ºç°çš„ä¸»é¢˜å°±æ˜¯é€šè¿‡æ··åˆæœç´¢æ¥å¢å¼º RAG æµç¨‹çš„æ£€ç´¢éƒ¨åˆ†ã€‚

æœ¬æ–‡å°†å‘æ‚¨ä»‹ç»æ··åˆæœç´¢çš„æ¦‚å¿µï¼Œè§£é‡Šå®ƒå¦‚ä½•é€šè¿‡æä¾›æ›´ç›¸å…³çš„æœç´¢ç»“æœæ¥å¢å¼ºæ‚¨çš„ RAG æµç¨‹æ€§èƒ½ï¼Œä»¥åŠåœ¨ä½•ç§æƒ…å†µä¸‹é€‚åˆä½¿ç”¨å®ƒã€‚

What is Hybrid Search

How Does Hybrid Search Work?

How Can Hybrid Search Improve the Performance of Your RAG Pipeline?

When Would You Use Hybrid Search?

Summary

### 01. What is Hybrid Search

Hybrid search is a search technique that combines two or more search algorithms to improve the relevance of search results. Although it is not defined which algorithms are combined, hybrid search most commonly refers to the combination of traditional keyword-based search and modern vector search.

Traditionally, keyword-based search was the obvious choice for search engines. But with the advent of Machine Learning (ML) algorithms, vector embeddings enabled a new search technique â€” called vector or semantic search â€” that allowed us to search across data semantically. However, both search techniques have essential tradeoffs to consider:

Keyword-based search: While its exact keyword-matching capabilities are beneficial for specific terms, such as product names or industry jargon, it is sensitive to typos and synonyms, which lead it to miss important context.

Vector or semantic search: While its semantic search capabilities allow multi-lingual and multi-modal search based on the data's semantic meaning and make it robust to typos, it can miss essential keywords. Additionally, it depends on the quality of the generated vector embeddings and is sensitive to out-of-domain terms.

Combining keyword-based and vector searches into a hybrid search allows you to leverage the advantages of both search techniques to improve search results' relevance, especially for text-search use cases.

For example, consider the search query "How to merge two Pandas DataFrames with .concat()?". The keyword search would help find relevant results for the method .concat(). However, since the word "merge" has synonyms such as "combine", "join", and "concatenate", it would be helpful if we could leverage the context awareness of semantic search (see more details in When Would You Use Hybrid Search).

If you are interested, you can play around with the different keyword-based, semantic, and hybrid search queries to search for movies in this live demo (its implementation is detailed in this article).

[Recreating Andrej Karpathyâ€™s Weekend Project â€” a Movie Search Engine | by Leonie Monigatti | Nov, 2023 | Towards Data Science](https://towardsdatascience.com/recreating-andrej-karpathys-weekend-project-a-movie-search-engine-9b270d7a92e4)

[awesome-moviate](https://awesome-moviate.weaviate.io/)

æ··åˆæœç´¢æ˜¯ä»€ä¹ˆï¼Ÿ

æ··åˆæœç´¢æ˜¯ä¸€ç§èåˆä¸¤ç§æˆ–æ›´å¤šæœç´¢ç®—æ³•çš„å…ˆè¿›æŠ€æœ¯ï¼Œç›®çš„æ˜¯æå‡æœç´¢ç»“æœçš„ç›¸å…³æ€§å’Œå‡†ç¡®æ€§ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæ··åˆæœç´¢æŒ‡çš„æ˜¯å°†ä¼ ç»Ÿçš„åŸºäºå…³é”®è¯çš„æœç´¢ä¸ç°ä»£çš„åŸºäºå‘é‡çš„æœç´¢ç»“åˆèµ·æ¥ã€‚

åœ¨è¿‡å»ï¼Œæœç´¢å¼•æ“ä¸»è¦ä¾èµ–äºå…³é”®è¯æœç´¢ã€‚ä½†éšç€æœºå™¨å­¦ä¹ ï¼ˆMLï¼‰çš„å‘å±•ï¼ŒåŸºäºå‘é‡åµŒå…¥çš„æ–°æœç´¢æŠ€æœ¯ â€”â€” ä¹Ÿå°±æ˜¯å‘é‡æˆ–è¯­ä¹‰æœç´¢ â€”â€” å¼€å§‹æµè¡Œã€‚è¿™ç§æŠ€æœ¯è®©æˆ‘ä»¬èƒ½å¤Ÿæ ¹æ®æ•°æ®çš„è¯­ä¹‰æ„ä¹‰è¿›è¡Œè·¨è¯­è¨€å’Œå¤šæ¨¡æ€çš„æœç´¢ã€‚ä¸è¿‡ï¼Œè¿™ä¸¤ç§æœç´¢æ–¹å¼éƒ½æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼š

å…³é”®è¯æœç´¢ï¼šå®ƒåœ¨åŒ¹é…ç‰¹å®šæœ¯è¯­ï¼ˆå¦‚äº§å“åæˆ–ä¸“ä¸šæœ¯è¯­ï¼‰æ–¹é¢è¡¨ç°å‡ºè‰²ï¼Œä½†å¯¹æ‹¼å†™é”™è¯¯å’ŒåŒä¹‰è¯è¾ƒä¸ºæ•æ„Ÿï¼Œå¯èƒ½ä¼šå¿½ç•¥ä¸€äº›é‡è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

å‘é‡æˆ–è¯­ä¹‰æœç´¢ï¼š å®ƒèƒ½å¤ŸåŸºäºæ•°æ®çš„è¯­ä¹‰å«ä¹‰è¿›è¡Œå¤šè¯­è¨€å’Œå¤šæ¨¡æ€æœç´¢ï¼Œå¯¹æ‹¼å†™é”™è¯¯å…·æœ‰è¾ƒå¥½çš„å®¹é”™æ€§ï¼Œä½†å¯èƒ½ä¼šå¿½è§†å…³é”®è¯ã€‚æ­¤å¤–ï¼Œå®ƒçš„æ•ˆæœä¾èµ–äºå‘é‡åµŒå…¥çš„è´¨é‡ï¼Œå¹¶å¯¹éä¸“ä¸šé¢†åŸŸçš„æœ¯è¯­è¾ƒä¸ºæ•æ„Ÿã€‚

æ··åˆæœç´¢ç»“åˆäº†è¿™ä¸¤ç§æ–¹æ³•çš„ä¼˜ç‚¹ï¼Œç‰¹åˆ«æ˜¯åœ¨æ–‡æœ¬æœç´¢æ–¹é¢ï¼Œèƒ½å¤Ÿæ˜¾è‘—æé«˜æœç´¢ç»“æœçš„ç›¸å…³æ€§å’Œå‡†ç¡®æ€§ã€‚

æ¯”å¦‚ï¼Œå½“æœç´¢ã€Œå¦‚ä½•ä½¿ç”¨ .concat() åˆå¹¶ä¸¤ä¸ª Pandas æ•°æ®æ¡†ï¼Ÿã€è¿™ä¸ªé—®é¢˜æ—¶ï¼Œå…³é”®è¯æœç´¢å¯ä»¥å¸®åŠ©æ‰¾åˆ°æ¶‰åŠ .concat() æ–¹æ³•çš„ç›¸å…³ä¿¡æ¯ã€‚åŒæ—¶ï¼Œç”±äºã€Œåˆå¹¶ã€ï¼ˆconcatï¼‰ä¸€è¯æœ‰è¯¸å¦‚ã€Œç»„åˆã€ã€ã€Œè¿æ¥ã€å’Œã€Œä¸²è”ã€ç­‰å¤šç§åŒä¹‰è¯ï¼Œè¯­ä¹‰æœç´¢çš„ä¸Šä¸‹æ–‡è¯†åˆ«åŠŸèƒ½åœ¨è¿™é‡Œå°±æ˜¾å¾—éå¸¸æœ‰ç”¨ï¼ˆæ›´å¤šè¯¦æƒ…å‚è§ä½•æ—¶ä½¿ç”¨æ··åˆæœç´¢ï¼‰ã€‚

æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥åœ¨è¿™ä¸ªå®æ—¶æ¼”ç¤ºä¸­ä½“éªŒä¸åŒçš„å…³é”®è¯æœç´¢ã€è¯­ä¹‰æœç´¢å’Œæ··åˆæœç´¢æŸ¥è¯¢ï¼Œç”¨æ¥æœç´¢ç”µå½±ï¼ˆè¯¦ç»†å®ç°å¯å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼‰ã€‚

### 02. How Does Hybrid Search Work?

Hybrid search combines keyword-based and vector search techniques by fusing their search results and reranking them.

Keyword-based search

Keyword-based search in the context of hybrid search often uses a representation called sparse embeddings, which is why it is also referred to as sparse vector search. Sparse embeddings are vectors with mostly zero values with only a few non-zero values, as shown below.

[0, 0, 0, 0, 0, 1, 0, 0, 0, 24, 3, 0, 0, 0, 0, ...]

Sparse embeddings can be generated with different algorithms. The most commonly used algorithm for sparse embeddings is BM25 (Best match 25), which builds upon the TF-IDF (Term Frequency-Inverse Document Frequency) approach and refines it. In simple terms, BM25 emphasizes the importance of terms based on their frequency in a document relative to their frequency across all documents.

æ··åˆæœç´¢æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

æ··åˆæœç´¢å°†å…³é”®è¯æœç´¢å’Œå‘é‡æœç´¢çš„ç»“æœç»“åˆèµ·æ¥ï¼Œé€šè¿‡é‡æ–°æ’åºè¿™äº›ç»“æœæ¥å®ç°ä¸¤ç§æœç´¢æŠ€æœ¯çš„èåˆã€‚

åŸºäºå…³é”®è¯çš„æœç´¢

åœ¨æ··åˆæœç´¢ä¸­ï¼ŒåŸºäºå…³é”®è¯çš„æœç´¢ç»å¸¸åˆ©ç”¨ä¸€ç§ç§°ä¸ºã€Œç¨€ç–åµŒå…¥ã€çš„è¡¨ç¤ºæ–¹å¼ï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸ºç¨€ç–å‘é‡æœç´¢ã€‚ç¨€ç–åµŒå…¥æ˜¯å¤§éƒ¨åˆ†å€¼ä¸ºé›¶ï¼Œä»…å°‘æ•°å€¼ä¸ºéé›¶çš„å‘é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

[0, 0, 0, 0, 0, 1, 0, 0, 0, 24, 3, 0, 0, 0, 0, ...]

ç”Ÿæˆç¨€ç–åµŒå…¥å¯ä»¥é‡‡ç”¨å¤šç§ç®—æ³•ã€‚æœ€å¸¸ç”¨çš„ç®—æ³•æ˜¯ BM25ï¼ˆæœ€ä½³åŒ¹é… 25ï¼‰ï¼Œè¿™ä¸ªç®—æ³•æ˜¯åœ¨ä¼ ç»Ÿçš„ TF-IDFï¼ˆè¯é¢‘-é€†æ–‡æ¡£é¢‘ç‡ï¼‰æ–¹æ³•çš„åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›çš„ã€‚ç®€è€Œè¨€ä¹‹ï¼ŒBM25 é€šè¿‡æ¯”è¾ƒä¸€ä¸ªè¯åœ¨ç‰¹å®šæ–‡æ¡£ä¸­çš„å‡ºç°é¢‘ç‡ä¸åœ¨æ‰€æœ‰æ–‡æ¡£ä¸­çš„æ™®éé¢‘ç‡ï¼Œæ¥ç¡®å®šè¿™ä¸ªè¯çš„é‡è¦æ€§ã€‚

Vector search

Vector search is a modern search technique that has emerged with the advances in ML. Modern ML algorithms, such as Transformers, can generate a numerical representation of data objects in various modalities (text, images, etc.) called vector embeddings.

These vector embeddings are usually densely packed with information and mostly comprised of non-zero values (dense vectors), as shown below. This is why vector search is also known as dense vector search.

[0.634, 0.234, 0.867, 0.042, 0.249, 0.093, 0.029, 0.123, 0.234, ...]

A search query is embedded into the same vector space as the data objects. Then, its vector embedding is used to calculate the closest data objects based on a specified similarity metric, such as cosine distance. The returned search results list the closest data objects ranked by their similarity to the search query.

[ğŸ¤— Transformers](https://huggingface.co/docs/transformers/index)

å‘é‡æœç´¢

å‘é‡æœç´¢æ˜¯éšç€æœºå™¨å­¦ä¹ æŠ€æœ¯çš„å‘å±•è€Œå…´èµ·çš„ä¸€ç§ç°ä»£æœç´¢æŠ€æœ¯ã€‚å¦‚ Transformers ç­‰ç°ä»£æœºå™¨å­¦ä¹ ç®—æ³•èƒ½å¤Ÿä¸ºå„ç§æ•°æ®å¯¹è±¡ï¼ˆæ¯”å¦‚æ–‡æœ¬ã€å›¾åƒç­‰ï¼‰ç”Ÿæˆä¸€ç§æ•°å€¼è¡¨ç¤ºå½¢å¼ï¼Œå³å‘é‡åµŒå…¥ã€‚

è¿™äº›å‘é‡åµŒå…¥é€šå¸¸ä¿¡æ¯å¯†é›†ï¼Œå¤§éƒ¨åˆ†ç”±éé›¶å€¼æ„æˆï¼ˆå¯†é›†å‘é‡ï¼‰ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºã€‚è¿™ä¹Ÿæ˜¯å‘é‡æœç´¢è¢«ç§°ä¸ºå¯†é›†å‘é‡æœç´¢çš„åŸå› ã€‚

[0.634, 0.234, 0.867, 0.042, 0.249, 0.093, 0.029, 0.123, 0.234, ...]

åœ¨å‘é‡æœç´¢ä¸­ï¼Œæœç´¢æŸ¥è¯¢ä¼šè¢«è½¬åŒ–ä¸ºä¸æ•°æ®å¯¹è±¡ç›¸åŒçš„å‘é‡ç©ºé—´ä¸­çš„ä¸€ä¸ªå‘é‡ã€‚ç„¶åï¼Œç³»ç»Ÿä¼šåˆ©ç”¨è¿™ä¸ªå‘é‡æ¥è®¡ç®—å“ªäº›æ•°æ®å¯¹è±¡ä¸å…¶æœ€æ¥è¿‘ï¼Œè¿™ä¸€è®¡ç®—é€šå¸¸åŸºäºæŸç§ç‰¹å®šçš„ç›¸ä¼¼åº¦åº¦é‡æ ‡å‡†ï¼Œä¾‹å¦‚ä½™å¼¦è·ç¦»ã€‚æœç´¢ç»“æœå°†æŒ‰ç…§ä¸æŸ¥è¯¢å‘é‡çš„ç›¸ä¼¼åº¦è¿›è¡Œæ’åºï¼Œå±•ç¤ºæœ€ç›¸ä¼¼çš„æ•°æ®å¯¹è±¡ã€‚

Fusion of keyword-based and vector search results

Both the keyword-based search and the vector search return a separate set of results, usually a list of search results sorted by their calculated relevance. These separate sets of search results must be combined.

There are many different strategies to combine the ranked results of two lists into one single ranking, as outlined in a paper by Benham and Culpepper [1].

Generally speaking, the search results are usually first scored. These scores can be calculated based on a specified metric, such as cosine distance, or simply just the rank in the search results list.

Then, the calculated scores are weighted with a parameter alpha, which dictates each algorithm's weighting and impacts the results' re-ranking.

hybrid_score = (1 - alpha) * sparse_score + alpha * dense_score

Usually, alpha takes a value between 0 and 1, with

alpha = 1: Pure vector search

alpha = 0: Pure keyword search

Below, you can see a minimal example of the fusion between keyword and vector search with scoring based on the rank and an alpha = 0.5.

Minimal example showcasing the different rankings of keyword-based search, vector search, and hybrid search.

Minimal example of how keyword and vector search results can be fused in hybrid search with scoring based on ranking and an alpha of 0.5 (Image by the author, inspired by Hybrid search explained)

[Risk-Reward Trade-offs in Rank Fusion](https://rodgerbenham.github.io/bc17-adcs.pdf)

èåˆå…³é”®è¯ä¸å‘é‡æœç´¢ç»“æœçš„æ–°æ–¹æ³•

å½“æˆ‘ä»¬ä½¿ç”¨å…³é”®è¯æœç´¢å’Œå‘é‡æœç´¢æ—¶ï¼Œå®ƒä»¬å„è‡ªä¼šå¸¦æ¥ä¸€ç³»åˆ—ç»“æœï¼Œè¿™äº›ç»“æœæŒ‰ç…§å®ƒä»¬è¢«è®¡ç®—å‡ºæ¥çš„ç›¸å…³æ€§è¿›è¡Œæ’åºã€‚è¿™ä¸¤å¥—ç»“æœéœ€è¦æœ‰æ•ˆåœ°ç»“åˆèµ·æ¥ã€‚

æ ¹æ® Benham å’Œ Culpepper çš„ç ”ç©¶ [1]ï¼Œåˆå¹¶è¿™ä¸¤ç§æœç´¢ç»“æœçš„æ’åæœ‰å¾ˆå¤šä¸åŒçš„æ–¹æ³•ã€‚

ä¸€èˆ¬æ¥è®²ï¼Œé¦–å…ˆè¦å¯¹æœç´¢ç»“æœè¿›è¡Œè¯„åˆ†ã€‚è¿™äº›è¯„åˆ†å¯ä»¥åŸºäºæŸäº›æ ‡å‡†ï¼Œä¾‹å¦‚ä½™å¼¦è·ç¦»ï¼Œæˆ–è€…ä»…ä»…æ˜¯åŸºäºæœç´¢ç»“æœçš„æ’åã€‚

æ¥ç€ï¼Œæˆ‘ä»¬ä¼šç”¨ä¸€ä¸ªåä¸º alpha çš„å‚æ•°æ¥å¯¹è¿™äº›åˆ†æ•°è¿›è¡ŒåŠ æƒï¼Œè¿™ä¸ªå‚æ•°å†³å®šäº†æ¯ç§æœç´¢ç®—æ³•çš„é‡è¦æ€§ï¼Œå¹¶å½±å“æœ€ç»ˆç»“æœçš„æ’åã€‚

hybrid_score = (1 - alpha) * sparse_score + alpha * dense_score

é€šå¸¸æƒ…å†µä¸‹ï¼Œalpha çš„å–å€¼åœ¨ 0 å’Œ 1 ä¹‹é—´ï¼Œå…·ä½“æ¥è¯´ï¼š

alpha = 1ï¼šå®Œå…¨åŸºäºå‘é‡çš„æœç´¢

alpha = 0ï¼šå®Œå…¨åŸºäºå…³é”®è¯çš„æœç´¢

ä¸‹å›¾æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œæ˜¾ç¤ºäº†åœ¨ alpha = 0.5 æ—¶ï¼ŒåŸºäºæ’åçš„å…³é”®è¯æœç´¢ä¸å‘é‡æœç´¢æ˜¯å¦‚ä½•èåˆçš„ã€‚

è¿™æ˜¯ä¸€ä¸ªå±•ç¤ºå…³é”®è¯æœç´¢ã€å‘é‡æœç´¢ä¸æ··åˆæœç´¢ä¸åŒæ’åçš„ç®€å•ç¤ºä¾‹ã€‚

è¿™ä¸ªç¤ºä¾‹ç®€å•é˜è¿°äº†åœ¨æ’ååŸºç¡€ä¸Šï¼Œä»¥ alpha å€¼ä¸º 0.5 æ—¶ï¼Œå…³é”®è¯å’Œå‘é‡æœç´¢ç»“æœæ˜¯å¦‚ä½•è¢«èåˆçš„ï¼ˆå›¾ç‰‡æ¥æºï¼šä½œè€…ï¼Œçµæ„Ÿæ¥è‡ªæ··åˆæœç´¢è§£é‡Šï¼‰

### 03. How Can Hybrid Search Improve the Performance of Your RAG Pipeline?

A RAG pipeline has many knobs you can tune to improve its performance. One of these knobs is to improve the relevance of the retrieved context that is then fed into the LLM because if the retrieved context is not relevant for answering a given question, the LLM won't be able to generate a relevant answer either.

Depending on your context type and query, you have to determine which of the three search techniques is most beneficial for your RAG application. Thus, the parameter alpha, which controls the weighting between keyword-based and semantic search, can be viewed as a hyperparameter that needs to be tuned.

In a common RAG pipeline using LangChain, you would define the retriever component by setting the used vectorstore component as the retriever with the .as_retriever() method as follows:

\# Define and populate vector store
\# See details here https://towardsdatascience.com/retrieval-augmented-generation-rag-from-theory-to-langchain-implementation-4e9bd5f6a4f2
vectorstore = ...

\# Set vectorstore as retriever
retriever = vectorstore.as_retriever()

However, this method only enables semantic search. If you want to enable hybrid search in LangChain, you will need to define a specific retriever component with hybrid search capabilities, such as the WeaviateHybridSearchRetriever:

```py
from langchain.retrievers.weaviate_hybrid_search import WeaviateHybridSearchRetriever

retriever = WeaviateHybridSearchRetriever(
    alpha = 0.5,               # defaults to 0.5, which is equal weighting between keyword and semantic search
    client = client,           # keyword arguments to pass to the Weaviate client
    index_name = "LangChain",  # The name of the index to use
    text_key = "text",         # The name of the text key to use
    attributes = [],           # The attributes to return in the results
)
```

The rest of the vanilla RAG pipeline will stay the same.

This small code change allows you to experiment with different weighting between keyword-based and vector searches. Note that setting alpha = 1 equals a fully semantic search as is the equivalent of defining the retriever from the vectorstore component directly (retriever = vectorstore.as_retriever()).

[Retrieval-Augmented Generation (RAG): From Theory to LangChain Implementation | by Leonie Monigatti | Nov, 2023 | Towards Data Science](https://towardsdatascience.com/retrieval-augmented-generation-rag-from-theory-to-langchain-implementation-4e9bd5f6a4f2)

å¦‚ä½•åˆ©ç”¨æ··åˆæœç´¢æå‡æ‚¨çš„ RAG æµç¨‹æ€§èƒ½ï¼Ÿ

RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æµç¨‹æœ‰å¾ˆå¤šè°ƒæ•´ç‚¹æ¥æé«˜æ€§èƒ½ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯æé«˜æ£€ç´¢å†…å®¹çš„ç›¸å…³æ€§ï¼Œè¿›è€Œè¾“å…¥åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ä¸­ã€‚å› ä¸ºå¦‚æœæ£€ç´¢å†…å®¹å¯¹äºå›ç­”ç‰¹å®šé—®é¢˜ä¸ç›¸å…³ï¼ŒLLM åŒæ ·éš¾ä»¥ç”Ÿæˆç›¸å…³ç­”æ¡ˆã€‚

ä½ éœ€è¦æ ¹æ®è‡ªå·±çš„ä¸Šä¸‹æ–‡ç±»å‹å’ŒæŸ¥è¯¢éœ€æ±‚ï¼Œé€‰æ‹©ä¸‰ç§æœç´¢æŠ€æœ¯ä¸­å“ªä¸€ç§æœ€é€‚åˆä½ çš„ RAG åº”ç”¨ã€‚å› æ­¤ï¼Œå‚æ•° **alpha**ï¼Œç”¨äºæ§åˆ¶åŸºäºå…³é”®è¯çš„æœç´¢ä¸è¯­ä¹‰æœç´¢ä¹‹é—´çš„æƒé‡ï¼Œè¢«è§†ä¸ºä¸€ä¸ªéœ€è¦è°ƒæ•´çš„å…³é”®å‚æ•°ã€‚

åœ¨ä¸€ä¸ªå…¸å‹çš„ä½¿ç”¨ LangChain çš„ RAG æµç¨‹ä¸­ï¼Œä½ ä¼šè¿™æ ·å®šä¹‰æ£€ç´¢å™¨ç»„ä»¶ï¼šé€šè¿‡è®¾ç½® vectorstore ç»„ä»¶ä½œä¸ºæ£€ç´¢å™¨ï¼Œå¹¶ä½¿ç”¨ .as_retriever() æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

ä½†æ˜¯ï¼Œè¿™ç§æ–¹å¼åªèƒ½å¼€å¯è¯­ä¹‰æœç´¢åŠŸèƒ½ã€‚å¦‚æœæ‚¨å¸Œæœ›åœ¨ LangChain ä¸­å¯ç”¨æ··åˆæœç´¢åŠŸèƒ½ï¼Œæ‚¨éœ€è¦å®šä¹‰ä¸€ä¸ªå…·å¤‡æ··åˆæœç´¢åŠŸèƒ½çš„ç‰¹å®š retriever ç»„ä»¶ï¼Œæ¯”å¦‚ WeaviateHybridSearchRetriever:

æ™®é€šçš„ RAG ç®¡é“å…¶ä½™éƒ¨åˆ†ä¿æŒä¸å˜ã€‚

é€šè¿‡è¿™ä¸€å°æ”¹åŠ¨ï¼Œæ‚¨å¯ä»¥è¯•éªŒå…³é”®è¯æœç´¢ä¸å‘é‡æœç´¢ä¹‹é—´ä¸åŒçš„æƒé‡åˆ†é…ã€‚è¯·æ³¨æ„ï¼Œå°† alpha = 1 è®¾ç½®ä¸ºå®Œå…¨çš„è¯­ä¹‰æœç´¢ï¼Œç›¸å½“äºç›´æ¥ä½¿ç”¨ vectorstore ç»„ä»¶å®šä¹‰æ£€ç´¢å·¥å…· (retriever = vectorstore.as_retriever())ã€‚

### 04. When Would You Use Hybrid Search (Hybrid Search Use Cases)

Hybrid search is ideal for use cases where you want to enable semantic search capabilities for a more human-like search experience but also require exact phrase matching for specific terms, such as product names or serial numbers.

An excellent example is the platform Stack Overflow, which has recently extended its search capabilities with semantic search by using hybrid search.

[Ask like a human: Implementing semantic search on Stack Overflow - Stack Overflow](https://stackoverflow.blog/2023/07/31/ask-like-a-human-implementing-semantic-search-on-stack-overflow/?source=post_page-----c75203c2f2f5--------------------------------)

Semantic search allows users to search using natural language instead of a rigid syntax of keyword manipulation. Searchâ€¦

Initially, Stack Overflow used TF-IDF to match keywords to documents [2]. However, describing the coding problem you are trying to solve can be difficult. It may lead to different results based on the words you use to describe your problem (e.g., combining two Pandas DataFrames can be done in different methods such as merging, joining, and concatenating). Thus, a more context-aware search method, such as semantic search, would be more beneficial for these cases.

However, on the other hand, a common use case of Stack Overflow is to copy-paste error messages. For this case, exact keyword matching is the preferred search method. Also, you will want exact keyword-matching capabilities for method and argument names (e.g., .read_csv() in Pandas).

As you can guess, many similar real-world use cases benefit from context-aware semantic searches but still rely on exact keyword matching. These use cases can strongly benefit from implementing a hybrid search retriever component.

ä½•æ—¶ä½¿ç”¨æ··åˆæœç´¢ï¼šæ··åˆæœç´¢çš„å®é™…åº”ç”¨åœºæ™¯

æ··åˆæœç´¢ç‰¹åˆ«é€‚ç”¨äºé‚£äº›æ—¢éœ€è¦è¯­ä¹‰æœç´¢åŠŸèƒ½ä»¥è¥é€ æ›´æ¥è¿‘äººç±»çš„æœç´¢ä½“éªŒï¼Œåˆéœ€è¦å¯¹ç‰¹å®šçš„è¯è¯­ï¼Œå¦‚äº§å“åç§°æˆ–åºåˆ—å·ï¼Œè¿›è¡Œç²¾å‡†åŒ¹é…çš„åœºåˆã€‚

ä¸€ä¸ªå…¸å‹çš„åº”ç”¨å®ä¾‹æ˜¯ Stack Overflow å¹³å°ã€‚æœ€è¿‘ï¼Œè¯¥å¹³å°å€ŸåŠ©æ··åˆæœç´¢æŠ€æœ¯ï¼Œå¼•å…¥äº†è¯­ä¹‰æœç´¢åŠŸèƒ½ï¼Œä»è€Œå‡çº§äº†å®ƒçš„æœç´¢èƒ½åŠ›ã€‚

åƒäººç±»ä¸€æ ·æé—®ï¼šStack Overflow å®æ–½è¯­ä¹‰æœç´¢çš„ç»éªŒ

èµ·åˆï¼ŒStack Overflow ä½¿ç”¨ TF-IDF æ–¹æ³•å°†å…³é”®è¯ä¸æ–‡æ¡£åŒ¹é… [2]ã€‚ä½†æè¿°ç¼–ç¨‹é—®é¢˜æœ‰æ—¶å¹¶ä¸ç®€å•ï¼Œä¸åŒçš„æè¿°è¯æ±‡å¯èƒ½å¯¼è‡´å®Œå…¨ä¸åŒçš„æœç´¢ç»“æœï¼ˆæ¯”å¦‚ï¼Œåˆå¹¶ä¸¤ä¸ª Pandas DataFrame å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼ï¼Œå¦‚åˆå¹¶ã€è¿æ¥æˆ–ä¸²è”ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ç§æ›´åŠ è€ƒè™‘ä¸Šä¸‹æ–‡çš„æœç´¢æ–¹æ³•ï¼Œä¾‹å¦‚è¯­ä¹‰æœç´¢ï¼Œå°†æ›´åŠ æœ‰æ•ˆã€‚

ç„¶è€Œï¼ŒStack Overflow çš„å¦ä¸€ä¸ªå¸¸è§ç”¨é€”æ˜¯å¤åˆ¶ç²˜è´´é”™è¯¯ä¿¡æ¯ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œç²¾ç¡®çš„å…³é”®è¯åŒ¹é…åˆ™æˆä¸ºé¦–é€‰ã€‚æ­¤å¤–ï¼Œå¯¹äºæ–¹æ³•åå’Œå‚æ•°åï¼ˆä¾‹å¦‚ Pandas ä¸­çš„ .read_csv()ï¼‰ï¼Œç²¾ç¡®åŒ¹é…åŒæ ·é‡è¦ã€‚

å¯ä»¥æƒ³è§ï¼Œå¾ˆå¤šç±»ä¼¼çš„ç°å®åœºæ™¯æ—¢éœ€è¦èƒ½å¤Ÿç†è§£ä¸Šä¸‹æ–‡çš„è¯­ä¹‰æœç´¢ï¼Œä¹Ÿä¾èµ–äºç²¾ç¡®çš„å…³é”®è¯åŒ¹é…ã€‚è¿™äº›åº”ç”¨åœºæ™¯ä»å®æ–½æ··åˆæœç´¢ä¸­è·ç›Šè‰¯å¤šã€‚

### 05. Summary

This article introduced the context of hybrid search as a combination of keyword-based and vector searches. Hybrid search merges the search results of the separate search algorithms and re-ranks the search results accordingly.

In hybrid search, the parameter alpha controls the weighting between keyword-based and semantic searches. This parameter alpha can be viewed as a hyperparameter to tune in RAG pipelines to improve the accuracy of search results.

Using the Stack Overflow [2] case study, we showcased how hybrid search can be useful for use cases where semantic search can improve the search experience. However, exact keyword matching is still important when specific terms are frequent.

æœ¬æ–‡ä»‹ç»äº†æ··åˆæœç´¢ï¼Œè¿™æ˜¯ä¸€ç§ç»“åˆäº†å…³é”®è¯å’Œå‘é‡æœç´¢çš„æ–¹æ³•ã€‚æ··åˆæœç´¢èåˆäº†ä¸åŒæœç´¢ç®—æ³•çš„ç»“æœï¼Œå¹¶å¯¹è¿™äº›ç»“æœè¿›è¡Œé‡æ–°æ’åºã€‚

åœ¨æ··åˆæœç´¢ä¸­ï¼Œå‚æ•° alpha ç”¨äºæ§åˆ¶å…³é”®è¯æœç´¢å’Œè¯­ä¹‰æœç´¢ä¹‹é—´çš„æƒé‡åˆ†é…ã€‚è¿™ä¸ª alpha å‚æ•°å¯ä»¥è§†ä¸ºåœ¨ RAG ç®¡é“ä¸­è°ƒæ•´ä»¥æå‡æœç´¢ç»“æœç²¾å‡†åº¦çš„ä¸€ä¸ªè¶…å‚æ•°ã€‚

å€ŸåŠ© Stack Overflow [2] çš„æ¡ˆä¾‹åˆ†æï¼Œæˆ‘ä»¬å±•ç¤ºäº†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¯­ä¹‰æœç´¢èƒ½å¤Ÿæå‡æœç´¢ä½“éªŒï¼Œä½†å¯¹äºç‰¹å®šæœ¯è¯­ï¼Œç²¾ç¡®çš„å…³é”®è¯åŒ¹é…ä»ç„¶éå¸¸å…³é”®ã€‚

### References

[1] Benham, R., & Culpepper, J. S. (2017). Risk-reward trade-offs in rank fusion. In Proceedings of the 22nd Australasian Document Computing Symposium (pp. 1â€“8).

[2] Haney, D. & Gibson, D. in Stack Overflow Blog. Ask like a human: Implementing semantic search on Stack Overflow (accessed Nov 24, 2023).
